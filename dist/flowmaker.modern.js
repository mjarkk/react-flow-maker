import t from"react";import e from"js-sha1";class n{constructor(){this.conf={components:{},introComponents:[]},this.errors=[]}title(t){return this.conf.components[t].title}get(){return this.conf}parseNewLogic(t){const e=[],n=(...t)=>{e.push(t.join(" ")),console.log("logic parse warning:",...t)};let o={components:{},introComponents:[]};return t.components&&(Array.isArray(t.components)?(t.components.map((t,e)=>{if(!t.name||!t.title)return void n(`logic.components[${e}] does not have a name or title field, this component will be ignored`);const s=[];let i={name:t.name,title:t.title,next:t.next?Array.isArray(t.next)?t.next:[t.next]:[],tooltip:t.tooltip,inputs:[],advancedInputs:[]};Array.isArray(t.inputs)&&t.inputs.map((t,o)=>{if(!t.title||!t.name||!t.type)return void n(`logic.components[${e}].inputs[${o}] does not have a name, type or title field, this input will be ignored`);if("function"!=typeof t.validation&&void 0!==t.validation)return void n(`logic.components[${e}].inputs[${o}].validation must be undefined or a function`);if("string"!=typeof t.tooltip&&void 0!==t.tooltip)return void n(`logic.components[${e}].inputs[${o}].tooltip must be a string or not undefined`);if(-1!=s.indexOf(t.name))return void n(`logic.components[${e}].inputs[${o}].name can't be equal to other names`);let a={name:t.name,title:t.title,type:t.type,validation:t.validation,tooltip:t.tooltip,default:t.default};switch(t.type){case"text":"string"!=typeof t.default&&void 0!==t.default&&(n(`logic.components[${e}].inputs[${o}].default must be a string or undefined, using default empty string`),a.default=""),null==t.default&&(a.default="");break;case"number":"number"!=typeof t.default&&void 0!==t.default&&(n(`logic.components[${e}].inputs[${o}].default must be a number or undefined, using default 0`),a.default=0),null==t.default&&(a.default=0);break;case"switch":"boolean"!=typeof t.default&&void 0!==t.default&&(n(`logic.components[${e}].inputs[${o}].default must be a boolean or undefined, using default empty string`),a.default=!1),null==t.default&&(a.default=!1);break;case"dropdown":if(!Array.isArray(t.options))return void n(`logic.components[${e}].inputs[${o}].options is not defined or is not an array, skipping this item`);a.options=t.options.map((t,s)=>{if("string"==typeof t.title&&"string"==typeof t.value&&("string"==typeof t.tooltip||null==t.tooltip))return{title:t.title,tooltip:t.tooltip,value:t.value};n(`logic.components[${e}].inputs[${o}].options[${s}] does not have the correct items (title string, value string, tooltip string), skipping this item`)}).filter(t=>t);break;default:return void n(`logic.components[${e}].inputs[${o}].type = '${t.type}' is not valid, this input will be ignored`)}s.push(t.name),i[t.advanced?"advancedInputs":"inputs"].push(a)}),o.components[t.name]=i}),Object.keys(o.components).map(t=>{o.components[t].next=o.components[t].next.filter(t=>!!o.components[t]||(n(`logic.component[???].next contains '${t}' that does not exsist, this item will be ignored`),!1))})):n("logic.components is not an array")),t.introComponents&&(Array.isArray(t.introComponents)?t.introComponents.map(t=>{o.components[t]?o.introComponents.push(t):n(`logic.introComponents['${t}'] is not a known component`)}):"string"==typeof t.introComponents?o.components[t.introComponents]?o.introComponents.push(t.introComponents):n(`logic.introComponents = '${name}' is not a known component`):n("logic.introComponents is not an array or string")),this.errors=e,this.conf=o,o}}var o={RandomString(t){let e="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<t;o++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}};class s{constructor(t,e){this.Logic=t,this.FlowMaker=e,this.maxDepth=0,this.flow=[],this.exportBuzzy=!1,this.reExport=!1,this.exportFunc=void 0}setExportFunc(t){this.exportFunc=t}caclMaxDepth(){const t=this;this.maxDepth=0;const e=n=>{n.map(n=>{n.depth>t.maxDepth&&(t.maxDepth=n.depth),e(n.next)})};e(this.flow),this.FlowMaker.forceUpdate()}flowItem(t,e,n){const s=o.RandomString(20);return{depth:n+1,next:[],id:s,path:[...e,s],inputData:{},inputValidation:{},component:t}}startFlow(t){let e=this.Logic.conf.components[t];e&&(this.flow.push(this.flowItem(e,[],0)),this.caclMaxDepth(),this.export())}addComponent(t,e){let n=this.Logic.conf.components[t];if(!n)return;let o=this.findPath(e);o.next.push(this.flowItem(n,o.path,o.depth)),this.caclMaxDepth(),this.export()}findPath(t){let e;const n=o=>{for(let s=0;s<o.length;s++){if(o[s].path===t){e=o[s];break}n(o[s].next)}};return n(this.flow),e}removeComponent(t){const e=n=>{n=Object.assign([],n);for(let o=0;o<n.length;o++){if(n[o].path===t){n.splice(o,1);break}n[o].next=e(n[o].next)}return n};this.flow=e(this.flow),this.caclMaxDepth(),this.export()}export(){this.exportBuzzy?this.reExport=!0:(this.exportBuzzy=!0,setTimeout(()=>{if(this.reExport)return this.exportBuzzy=!1,this.reExport=!1,void this.export();let t=[];const e=(t,n)=>{n.map(n=>{let o={},s={};Object.keys(n.inputData).map(t=>{o[t]=n.inputData[t].value,n.inputData[t].error&&(s[t]=n.inputData[t].error)}),t.push({component:{title:n.component.title,name:n.component.name},inputs:o,inputErrors:s,id:n.id,next:[]}),e(t[t.length-1].next,n.next)})};e(t,this.flow),"function"==typeof this.exportFunc&&this.exportFunc(t),setTimeout(()=>{this.exportBuzzy=!1,this.reExport&&(this.reExport=!1,this.export())},30)},50))}import(t){if(!Array.isArray(t))return;let e=[];const n=(t,e,o)=>{t.map(t=>{let s=this.flowItem(this.Logic.conf.components[t.component.name],o,o.length);s.id=t.id,s.inputData=Object.keys(t.inputs).reduce((e,n)=>(e[n]={value:t.inputs[n],error:""},e),{}),s.path.splice(-1,1),s.path.push(t.id),e.push(s),n(t.next,e[e.length-1].next,[...o,t.id])})};n(t,e,[]),this.flow=e,this.caclMaxDepth()}updateInputValue(t,e,n,o){let s=this.findPath(t);s&&(o?s.component.advancedInputs&&s.component.advancedInputs[n]&&(s.inputData[s.component.advancedInputs[n].name]=e):s.component.inputs&&s.component.inputs[n]&&(s.inputData[s.component.inputs[n].name]=e)),this.export()}}const i=()=>t.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},t.createElement("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}),t.createElement("path",{d:"M0 0h24v24H0z",fill:"none"})),a=()=>t.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},t.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),t.createElement("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v10zM18 4h-2.5l-.71-.71c-.18-.18-.44-.29-.7-.29H9.91c-.26 0-.52.11-.7.29L8.5 4H6c-.55 0-1 .45-1 1s.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1z"})),r=()=>t.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},t.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),t.createElement("path",{d:"M8.71 11.71l2.59 2.59c.39.39 1.02.39 1.41 0l2.59-2.59c.63-.63.18-1.71-.71-1.71H9.41c-.89 0-1.33 1.08-.7 1.71z"})),l=()=>t.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},t.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),t.createElement("path",{d:"M8.71 12.29L11.3 9.7c.39-.39 1.02-.39 1.41 0l2.59 2.59c.63.63.18 1.71-.71 1.71H9.41c-.89 0-1.33-1.08-.7-1.71z"})),p=()=>t.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24"},t.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),t.createElement("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1zm1-8h-2V7h2v2z"})),c=()=>t.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},t.createElement("path",{d:"M0 0h24v24H0z",fill:"none"}),t.createElement("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})),h=()=>t.createElement("svg",{className:"flow-alertIcon",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},t.createElement("path",{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}),t.createElement("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),t.createElement("line",{x1:"12",y1:"17",x2:"12",y2:"17"}));class d extends t.Component{constructor(){super(),this.state={open:!1}}clickRoundButton(){this.setState({open:!this.state.open})}clickOption(t){this.props.out(t),this.setState({open:!1})}render(){const e=this.props,n=this.state;return t.createElement("div",{className:"flow-addIcon"},t.createElement("div",{className:"flow-round "+(n.open?"flow-open":"flow-closed"),onClick:()=>this.clickRoundButton()},t.createElement(i,null)),t.createElement("div",{className:"flow-options "+(n.open?"flow-open":"flow-closed")},e.options?e.options.map((e,n)=>t.createElement("div",{onClick:()=>this.clickOption(e),key:n,className:"flow-option"},this.props?this.props.Logic.title(e):e)):""))}}class m extends t.Component{render(){return this.props.tip?t.createElement("div",{className:"flow-tooltip flow-transparrent"+(this.props.transparrent?"True":"False")},t.createElement("div",{className:"flow-icon"},t.createElement(p,null)),t.createElement("div",{className:"flow-noWidth"},t.createElement("div",{className:"flow-fullwidth"},t.createElement("div",{className:"flow-popup"},this.props.tip)))):""}}class u extends t.Component{constructor(){super(),this.refID="",this.state={value:"",error:"",dropDownSelected:-1,isAfterInit:!1,dropDownopen:!1}}tellParent(){this.props.onChange&&this.props.onChange({error:this.state.error,value:this.state.value})}updateDefaultVal(){if(this.props.input&&!this.state.isAfterInit||this.refID!=this.props.refID){this.refID=this.props.refID;const t=void 0!==this.props.initalVal?this.props.initalVal:this.props.input.default;this.setState({value:t,isAfterInit:!0},()=>{this.validate(t,()=>{if("dropdown"==this.props.input.type&&-1==this.state.dropDownSelected){let e=0;this.props.input.options.map((n,o)=>{n.value==t&&(e=o)}),this.setState({dropDownSelected:e})}this.tellParent()})})}}validate(t,e){if("function"==typeof this.props.input.validation){let n=this.props.input.validation(void 0,t);"string"!=typeof n&&(n=""),this.setState({error:n},e)}"function"==typeof e&&e()}updateValue(t){this.setState({value:t},()=>{this.validate(t,()=>{this.tellParent()})})}componentDidMount(){this.updateDefaultVal()}componentDidUpdate(){this.updateDefaultVal(),this.props.hiddenDropdown&&this.state.dropDownopen&&this.setState({dropDownopen:!1})}render(){const e=this.state.error,n=this.props.input;let o;if(!n)return t.createElement("div",{className:"flow-input"});const s=()=>t.createElement("div",{className:"flow-label",onClick:()=>o?o.focus():"switch"==n.type?this.updateValue(!this.state.value):""},t.createElement("span",null,n.title),t.createElement(m,{transparrent:!0,tip:n.tooltip}));return t.createElement("div",{className:`flow-input flow-input-type-${n.type} flow-hasErr${e?"True":"False"}`},"switch"!=n.type?t.createElement(s,null):"",t.createElement("div",{className:"flow-actualInput"},"text"==n.type||"number"==n.type?t.createElement("div",{className:"flow-text"},t.createElement("input",{ref:t=>o=t,type:n.type,value:this.state.value,onChange:t=>this.updateValue(t.target.value)})):"switch"==n.type?t.createElement("div",{className:"flow-switch"},t.createElement("div",{onClick:()=>this.updateValue(!this.state.value),className:"flow-actualSwitch "+(this.state.value?"flow-true":"flow-false")},t.createElement("div",{className:"flow-inside"},t.createElement(c,null)))):"dropdown"==n.type?t.createElement("div",{className:"flow-dropdown"},t.createElement("div",{className:"flow-select",onClick:()=>this.setState({dropDownopen:!this.state.dropDownopen})},t.createElement("div",{className:"flow-optTitle"},-1!=this.state.dropDownSelected&&n.options&&0!=n.options.length?n.options[this.state.dropDownSelected].title:"..."),t.createElement("div",{className:"flow-icon"},n.options&&0!=n.options.length?t.createElement(r,null):"")),t.createElement("div",{className:"flow-options flow-open"+(this.state.dropDownopen?"True":"False")},n.options.map((e,n)=>t.createElement("div",{key:n,className:"flow-option",onClick:()=>{this.updateValue(e.value),this.setState({dropDownSelected:n,dropDownopen:!1})}},t.createElement("div",{className:"flow-optTitle"},e.title),t.createElement(m,{tip:e.tooltip}))))):""),"switch"==n.type?t.createElement(s,null):"",e?t.createElement("div",{className:"flow-error"},e):"")}}class f extends t.Component{constructor(){super(),this.state={hover:!1,showAddOptions:!1,showAdvanced:!1},this.remove=this.remove.bind(this)}remove(){this.props.graphInstance.props.Tree.removeComponent(this.props.graphInstance.props.data.path)}add(){1!=this.props.graphInstance.props.data.component.next.length?this.setState({showAddOptions:!0}):this.realAdd(this.props.graphInstance.props.data.component.next[0])}realAdd(t){this.setState({showAddOptions:!1}),t&&this.props.graphInstance.props.Tree.addComponent(t,this.props.graphInstance.props.data.path)}render(){const e=this.props.graphInstance.props.data;if(!e)return"";const n=e.component,o=n.inputs,s=n.advancedInputs;return t.createElement("div",{className:"flow-fullBlock flow-hover"+(this.state.hover&&!this.state.showAddOptions?"True":"False"),onMouseOver:()=>{this.state.hover||this.setState({hover:!0})},onMouseOut:()=>{this.state.hover&&this.setState({hover:!1})}},t.createElement("div",{className:"flow-side"},t.createElement("div",{className:"flow-innerSide"},t.createElement("div",{className:"flow-round",onClick:this.remove},t.createElement(a,null)))),t.createElement("div",{className:"flow-middle"},t.createElement("div",{className:"flow-title"},n.title,t.createElement(m,{transparrent:!0,tip:n.tooltip})),t.createElement("div",{className:"flow-inputs"},o.map((n,o)=>{const s=e.inputData[n.name];return t.createElement(u,{refID:e.id,key:o,input:n,initalVal:s?s.value:void 0,onChange:t=>{this.props.graphInstance.props.Tree.updateInputValue(e.path,t,o,!1)}})}),s.length>0?(()=>{const n=s.filter(t=>!0!==(!e.inputData[t.name]||!t.validation||t.validation(void 0,e.inputData[t.name].value))).length>0&&!this.state.showAdvanced;return t.createElement("div",{className:"flow-showAdvanced"},t.createElement("div",{className:"flow-button error"+(n?"True":"False"),onClick:()=>{this.setState({showAdvanced:!this.state.showAdvanced},()=>{this.props.graphParrentInstance?this.props.graphParrentInstance.forceUpdate():this.props.graphInstance&&this.props.graphInstance.forceUpdate()})}},n?t.createElement(h,null):"","Advanced ",t.createElement(this.state.showAdvanced?l:r,null)))})():""),t.createElement("div",{className:"flow-inputs flow-advancedInputs flow-show"+(this.state.showAdvanced?"True":"False")},s.map((n,o)=>{const s=e.inputData[n.name];return t.createElement(u,{hiddenDropdown:!this.state.showAdvanced,key:o,input:n,initalVal:s?s.value:void 0,onChange:t=>{this.props.graphInstance.props.Tree.updateInputValue(e.path,t,o,!0)}})}))),n.next.length>0?t.createElement("div",{className:"flow-nextOptions flow-show"+(this.state.showAddOptions?"True":"False")},t.createElement("div",{className:"flow-closePopup",onClick:()=>this.realAdd()},t.createElement(i,null)),t.createElement("div",{className:"flow-pos"},t.createElement("div",{className:"flow-optionsTitle"},"Options"),n.next.map((e,n)=>t.createElement("div",{onClick:()=>this.realAdd({componentName:e}),className:"flow-option",key:n},this.props?this.props.graphInstance.props.Logic.title(e):e)))):"",n.next.length>0?t.createElement("div",{className:"flow-side"},t.createElement("div",{className:"flow-innerSide"},t.createElement("div",{className:"flow-round",onClick:()=>this.add()},t.createElement(i,null)))):"")}}const w=class extends t.Component{constructor(){super(),this.state={element:void 0,lastParentPosition:0},this.mounted=!1}componentDidMount(){this.mounted=!0,this.watchParent()}componentWillUnmount(){this.mounted=!1}watchParent(){if(this.mounted){let t,e=this.props.connectTo;e&&(t=e.getBoundingClientRect(),t.top!=this.state.lastParentPosition&&this.setState({lastParentPosition:t.top})),setTimeout(()=>{this.watchParent()},800)}}render(){let e=0,n=0,o="";if(this.props.connectTo&&this.state.element){let t=this.props.connectTo.getBoundingClientRect(),s=this.state.element.getBoundingClientRect(),i=t.y+t.height/2-(s.y+s.height/2);0==i?(e=20,n=10,o="straight"):i<0?(e=20-i,n=e-10,o="bottomToTop"):(e=i+20,n=10,o="topToBottom")}return t.createElement("div",{className:"flow-graphPart",style:{width:this.props.width}},e&&n&&o?t.createElement("div",{className:"flow-lineToParrent",style:{bottom:`${n}px`}},t.createElement("svg",{viewBox:`0 0 80 ${e}`,height:`${e}px`,style:{minHeight:`${e}px`},xmlns:"http://www.w3.org/2000/svg"},t.createElement("path","bottomToTop"==o?{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:`M0,10 C70,10 30,${e-10} 80,${e-10}`}:"topToBottom"==o?{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:`M0,${e-10} C70,${e-10} 30,10 80,10`}:{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:"M0,10 C70,10 30,10 80,10"}))):"",t.createElement("div",{ref:t=>{let e,n=this.props.connectTo;if(n&&(e=n.getBoundingClientRect()),"object"==typeof this.state.element&&(!e||e.top==this.state.lastParentPosition))return;let o={element:t};e&&(o.lastParentPosition=e.top),this.setState(o)},className:"flow-graph",style:{minWidth:this.props.itemWidth}},t.createElement(f,{graphInstance:this,graphParrentInstance:this.props.connectToInstance})),t.createElement("div",{className:"flow-next"},this.props.data.next.map((e,n)=>t.createElement(w,{Tree:this.props.Tree,Logic:this.props.Logic,connectTo:this.state.element,connectToInstance:this,width:this.props.width-this.props.itemWidth,itemWidth:this.props.itemWidth,key:n,data:e}))))}};export default class extends t.Component{constructor(){super(),this.Logic=new n,this.Tree=new s(this.Logic,this),this.lastlogicHash="",this.state={settings:this.Logic.get()}}componentDidMount(){const t=e(this.props.logic);t!=this.lastlogicHash?(this.lastlogicHash=t,this.setState({settings:this.Logic.parseNewLogic(this.props.logic)},()=>this.afterMount())):this.afterMount()}afterMount(){"function"==typeof this.props.onChange&&this.Tree.setExportFunc(this.props.onChange),"object"==typeof this.props.flow&&this.Tree.import(this.props.flow)}render(){const e=this.state.settings;return t.createElement("div",{className:"flowMakerComp"},t.createElement("div",{className:"flowMakerContainer",style:{minWidth:250+380*this.Tree.maxDepth+"px"}},t.createElement("div",{className:"flow-row",style:{minWidth:"250px"}},e.introComponents.length>0?t.createElement("div",{className:"flow-startPoint"},t.createElement("h3",null,"Start here"),t.createElement(d,{Tree:this.Tree,Logic:this.Logic,options:e.introComponents,out:t=>this.Tree.startFlow(t)})):""),t.createElement("div",{className:"flow-actualGraph",style:{width:380*this.Tree.maxDepth+"px"}},this.Tree.flow.map((e,n)=>t.createElement(w,{Tree:this.Tree,Logic:this.Logic,width:380*this.Tree.maxDepth,itemWidth:380,key:n,data:e})))))}}
//# sourceMappingURL=flowmaker.modern.js.map
