"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("js-sha1");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(e),a=n(t);class l{constructor(){this.conf={components:{},introComponents:[]},this.errors=[]}title(e){return this.conf.components[e].title}get(){return this.conf}parseInput(e,t=(e=>console.log("logic parse warning:",e))){let n={name:e.name,title:e.title,type:e.type,validation:e.validation,tooltip:e.tooltip,default:e.default};switch(e.type){case"text":"string"!=typeof e.default&&void 0!==e.default&&(t(`.inputs[${e.name}].default must be a string or undefined, using default empty string`),n.default=""),null==e.default&&(n.default="");break;case"number":"number"!=typeof e.default&&void 0!==e.default&&(t(`.inputs[${e.name}].default must be a number or undefined, using default 0`),n.default=0),null==e.default&&(n.default=0);break;case"switch":"boolean"!=typeof e.default&&void 0!==e.default&&(t(`.inputs[${e.name}].default must be a boolean or undefined, using default empty string`),n.default=!1),null==e.default&&(n.default=!1);break;case"dropdown":if(!Array.isArray(e.options))return void t(`.inputs[${e.name}].options is not defined or is not an array, skipping this item`);n.options=e.options.map(((n,o)=>{if("string"==typeof n.title&&"string"==typeof n.value&&("string"==typeof n.tooltip||null==n.tooltip))return{title:n.title,tooltip:n.tooltip,value:n.value};t(`.inputs[${e.name}].options[${o}] does not have the correct items (title string, value string, tooltip string), skipping this item`)})).filter((e=>e));break;default:return void t(`.inputs[${e.name}].type = '${e.type}' is not valid, this input will be ignored`)}return n}parseNewLogic(e){const t=[],n=(...e)=>{t.push(e.join(" ")),console.log("logic parse warning:",...e)};let o={components:{},introComponents:[]};return e.components&&(Array.isArray(e.components)?(e.components.map(((e,t)=>{if(!e.name||!e.title)return void n(`logic.components[${t}] does not have a name or title field, this component will be ignored`);const a=[];let l={name:e.name,title:e.title,next:e.next?Array.isArray(e.next)?e.next:[e.next]:[],tooltip:e.tooltip,inputs:[],getInputs:void 0,advancedInputs:[]};e.getInputs&&(l.getInputs=e.getInputs),Array.isArray(e.inputs)&&e.inputs.map(((e,o)=>{if(!e.title||!e.name||!e.type)return void n(`logic.components[${t}].inputs[${o}] does not have a name, type or title field, this input will be ignored`);if("function"!=typeof e.validation&&void 0!==e.validation)return void n(`logic.components[${t}].inputs[${o}].validation must be undefined or a function`);if("string"!=typeof e.tooltip&&void 0!==e.tooltip)return void n(`logic.components[${t}].inputs[${o}].tooltip must be a string or not undefined`);if(-1!=a.indexOf(e.name))return void n(`logic.components[${t}].inputs[${o}].name can't be equal to other names`);const i=this.parseInput(e,(e=>n(`logic.components[${t}]${e}`)));i&&(a.push(e.name),l[e.advanced?"advancedInputs":"inputs"].push(i))})),o.components[e.name]=l})),Object.keys(o.components).map((e=>{o.components[e].next=o.components[e].next.filter((e=>!!o.components[e]||(n(`logic.component[???].next contains '${e}' that does not exsist, this item will be ignored`),!1)))}))):n("logic.components is not an array")),e.introComponents&&(Array.isArray(e.introComponents)?e.introComponents.map((e=>{o.components[e]?o.introComponents.push(e):n(`logic.introComponents['${e}'] is not a known component`)})):"string"==typeof e.introComponents?o.components[e.introComponents]?o.introComponents.push(e.introComponents):n(`logic.introComponents = '${name}' is not a known component`):n("logic.introComponents is not an array or string")),this.errors=t,this.conf=o,o}}var i={RandomString(e){let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<e;o++)t+=n.charAt(Math.floor(Math.random()*n.length));return t}};class r{constructor(e,t){this.Logic=e,this.forceUpdate=t,this.maxDepth=0,this.flow=[],this.exportBuzzy=!1,this.reExport=!1,this.exportFunc=void 0}setExportFunc(e){this.exportFunc=e}caclMaxDepth(){const e=this;this.maxDepth=0;const t=n=>{n.map((n=>{n.depth>e.maxDepth&&(e.maxDepth=n.depth),t(n.next)}))};t(this.flow),this.forceUpdate()}flowItem(e,t,n){const o=i.RandomString(20);return{depth:n+1,next:[],id:o,path:[...t,o],inputData:{},inputValidation:{},component:e}}startFlow(e){let t=this.Logic.conf.components[e];t&&(this.flow.push(this.flowItem(t,[],0)),this.caclMaxDepth(),this.export())}addComponent(e,t){let n=this.Logic.conf.components[e];if(!n)return;let o=this.findPath(t);o.next.push(this.flowItem(n,o.path,o.depth)),this.caclMaxDepth(),this.export()}findPath(e){let t;const n=o=>{for(let a=0;a<o.length;a++){if(o[a].path===e){t=o[a];break}n(o[a].next)}};return n(this.flow),t}removeComponent(e){const t=n=>{n=Object.assign([],n);for(let o=0;o<n.length;o++){if(n[o].path===e){n.splice(o,1);break}n[o].next=t(n[o].next)}return n};this.flow=t(this.flow),this.caclMaxDepth(),this.export()}itemToExport(e){let t={},n={};return Object.keys(e.inputData).map((o=>{t[o]=e.inputData[o].value,e.inputData[o].error&&(n[o]=e.inputData[o].error)})),{component:{title:e.component.title,name:e.component.name},inputs:t,inputErrors:n,id:e.id,next:[]}}export(){this.exportBuzzy?this.reExport=!0:(this.exportBuzzy=!0,setTimeout((()=>{if(this.reExport)return this.exportBuzzy=!1,this.reExport=!1,void this.export();let e=[];const t=(e,n)=>{n.map((n=>{e.push(this.itemToExport(n)),t(e[e.length-1].next,n.next)}))};t(e,this.flow),"function"==typeof this.exportFunc&&this.exportFunc(e),setTimeout((()=>{this.exportBuzzy=!1,this.reExport&&(this.reExport=!1,this.export())}),30)}),50))}import(e){if(!Array.isArray(e))return;let t=[];const n=(e,t,o)=>{e.map((e=>{let a=this.flowItem(this.Logic.conf.components[e.component.name],o,o.length);a.id=e.id,a.inputData=Object.keys(e.inputs).reduce(((t,n)=>(t[n]={value:e.inputs[n],error:""},t)),{}),a.path.splice(-1,1),a.path.push(e.id),t.push(a),n(e.next,t[t.length-1].next,[...o,e.id])}))};n(e,t,[]),this.flow=t,this.caclMaxDepth()}updateInputValue(e,t,n){let o=this.findPath(e);o&&(o.inputData[n]=t),this.export()}}const s=()=>o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},o.default.createElement("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}),o.default.createElement("path",{d:"M0 0h24v24H0z",fill:"none"})),c=()=>o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},o.default.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),o.default.createElement("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v10zM18 4h-2.5l-.71-.71c-.18-.18-.44-.29-.7-.29H9.91c-.26 0-.52.11-.7.29L8.5 4H6c-.55 0-1 .45-1 1s.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1z"})),p=()=>o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},o.default.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),o.default.createElement("path",{d:"M8.71 11.71l2.59 2.59c.39.39 1.02.39 1.41 0l2.59-2.59c.63-.63.18-1.71-.71-1.71H9.41c-.89 0-1.33 1.08-.7 1.71z"})),d=()=>o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},o.default.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),o.default.createElement("path",{d:"M8.71 12.29L11.3 9.7c.39-.39 1.02-.39 1.41 0l2.59 2.59c.63.63.18 1.71-.71 1.71H9.41c-.89 0-1.33-1.08-.7-1.71z"})),u=()=>o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24"},o.default.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),o.default.createElement("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1zm1-8h-2V7h2v2z"})),f=()=>o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},o.default.createElement("path",{d:"M0 0h24v24H0z",fill:"none"}),o.default.createElement("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})),m=()=>o.default.createElement("svg",{className:"flow-alertIcon",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},o.default.createElement("path",{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}),o.default.createElement("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),o.default.createElement("line",{x1:"12",y1:"17",x2:"12",y2:"17"}));function h({options:t,Logic:n,out:a}){const[l,i]=e.useState(!1);return o.default.createElement("div",{className:"flow-addIcon"},o.default.createElement("div",{className:"flow-round "+(l?"flow-open":"flow-closed"),onClick:()=>i((e=>!e))},o.default.createElement(s,null)),o.default.createElement("div",{className:"flow-options "+(l?"flow-open":"flow-closed")},t?t.map(((e,t)=>o.default.createElement("div",{onClick:()=>function(e){a(e),i(!1)}(e),key:t,className:"flow-option"},n?n.title(e):e))):""))}function w({tip:e,transparrent:t}){return e?o.default.createElement("div",{className:"flow-tooltip flow-transparrent"+(t?"True":"False")},o.default.createElement("div",{className:"flow-icon"},o.default.createElement(u,null)),o.default.createElement("div",{className:"flow-noWidth"},o.default.createElement("div",{className:"flow-fullwidth"},o.default.createElement("div",{className:"flow-popup"},e)))):""}class v{constructor(){this.val=""}}function g({onChange:t,hiddenDropdown:n,input:a,refID:l,initalVal:i}){const[r]=e.useState(new v),[s,c]=e.useState({dropDownSelected:-1,dropDownopen:!1}),[d,u]=e.useState(!1),[m,h]=e.useState(void 0),[g,E]=e.useState("");function x(){if(a&&!d||r.val!=l){r.val=l;let e=void 0!==i?i:a.default;if(void 0===e&&("text"==a.type||"number"==a.type?e="":"switch"==a.type&&(e=!1)),h(e),"dropdown"==a.type&&-1==s.dropDownSelected){let t=0;a.options.map(((n,o)=>{n.value==e&&(t=o)})),c((e=>({...e,dropDownSelected:t})))}u(!0)}}let y;if(e.useEffect((()=>{if("function"==typeof a.validation&&void 0!==m){let e=a.validation(void 0,m);"string"!=typeof e&&(e=""),E(e)}}),[m]),e.useEffect((()=>{t&&void 0!==m&&t({error:g,value:m})}),[m,g]),e.useEffect((()=>x()),[]),e.useEffect((()=>{x(),n&&s.dropDownopen&&c((e=>({...e,dropDownopen:!1})))}),[n]),!a)return o.default.createElement("div",{className:"flow-input"});const N=()=>o.default.createElement("div",{className:"flow-label",onClick:()=>y?y.focus():"switch"==a.type?h(!m):""},o.default.createElement("span",null,a.title),o.default.createElement(w,{transparrent:!0,tip:a.tooltip}));return o.default.createElement("div",{className:`flow-input flow-input-type-${a.type} flow-hasErr${g?"True":"False"}`},"switch"!=a.type?o.default.createElement(N,null):"",o.default.createElement("div",{className:"flow-actualInput"},void 0===m||"text"!=a.type&&"number"!=a.type?void 0!==m&&"switch"==a.type?o.default.createElement("div",{className:"flow-switch"},o.default.createElement("div",{onClick:()=>h(!m),className:"flow-actualSwitch "+(m?"flow-true":"flow-false")},o.default.createElement("div",{className:"flow-inside"},o.default.createElement(f,null)))):"dropdown"==a.type?o.default.createElement("div",{className:"flow-dropdown"},o.default.createElement("div",{className:"flow-select",onClick:()=>c((e=>({...e,dropDownopen:!s.dropDownopen})))},o.default.createElement("div",{className:"flow-optTitle"},-1!=s.dropDownSelected&&a.options&&0!=a.options.length?a.options[s.dropDownSelected].title:"..."),o.default.createElement("div",{className:"flow-icon"},a.options&&0!=a.options.length?o.default.createElement(p,null):"")),o.default.createElement("div",{className:"flow-options flow-open"+(s.dropDownopen?"True":"False")},a.options.map(((e,t)=>o.default.createElement("div",{key:t,className:"flow-option",onClick:()=>{h(e.value),c((e=>({...e,dropDownSelected:t,dropDownopen:!1})))}},o.default.createElement("div",{className:"flow-optTitle"},e.title),o.default.createElement(w,{tip:e.tooltip})))))):"":o.default.createElement("div",{className:"flow-text"},o.default.createElement("input",{ref:e=>y=e,type:a.type,value:m,onChange:e=>h(e.target.value)}))),"switch"==a.type?o.default.createElement(N,null):"",g?o.default.createElement("div",{className:"flow-error"},g):"")}function E({Tree:t,Logic:n,data:a,graphInstanceForceUpdate:l,graphParrentInstanceForceUpdate:i,reRenderFullTree:r}){let[u,f]=e.useState({hover:!1,showAddOptions:!1});const[h,v]=e.useState(!1),[E,x]=e.useState(!1),y=()=>x((e=>!e));function N(e){f((e=>({...e,showAddOptions:!1}))),e&&(t.addComponent(e,a.path),r())}if(e.useEffect((()=>{i?i():l&&l()}),[h]),!a)return"";const T=a.component;let{inputs:k,advancedInputs:C}=T;if(T.getInputs){const e=t.itemToExport(a);let o=T.getInputs(e);Array.isArray(o)&&(k=[],C=[],o.map((e=>{const t=n.parseInput(e);t&&(e.advanced?C.push(t):k.push(t))})))}return o.default.createElement("div",{className:"flow-fullBlock flow-hover"+(u.hover&&!u.showAddOptions?"True":"False"),onMouseEnter:()=>{u.hover||f((e=>({...e,hover:!0})))},onMouseLeave:()=>{u.hover&&f((e=>({...e,hover:!1})))}},o.default.createElement("div",{className:"flow-side"},o.default.createElement("div",{className:"flow-innerSide"},o.default.createElement("div",{className:"flow-round",onClick:function(){t.removeComponent(a.path),r()}},o.default.createElement(c,null)))),o.default.createElement("div",{className:"flow-middle"},o.default.createElement("div",{className:"flow-title"},T.title,o.default.createElement(w,{transparrent:!0,tip:T.tooltip})),o.default.createElement("div",{className:"flow-inputs"},k.map((e=>{const n=a.inputData[e.name];return o.default.createElement(g,{refID:a.id,key:e.name,input:e,initalVal:n?n.value:void 0,onChange:n=>{t.updateInputValue(a.path,n,e.name),y()}})})),C.length>0?(()=>{const e=C.filter((e=>!0!==(!a.inputData[e.name]||!e.validation||e.validation(void 0,a.inputData[e.name].value)))).length>0&&!h;return o.default.createElement("div",{className:"flow-showAdvanced"},o.default.createElement("div",{className:"flow-button error"+(e?"True":"False"),onClick:()=>v(!h)},e?o.default.createElement(m,null):"","Advanced ",h?o.default.createElement(d,null):o.default.createElement(p,null)))})():""),o.default.createElement("div",{className:"flow-inputs flow-advancedInputs flow-show"+(h?"True":"False")},C.map(((e,n)=>{const l=a.inputData[e.name];return o.default.createElement(g,{hiddenDropdown:!h,key:n,input:e,initalVal:l?l.value:void 0,onChange:n=>{t.updateInputValue(a.path,n,e.name),y()}})})))),T.next.length>0?o.default.createElement("div",{className:"flow-nextOptions flow-show"+(u.showAddOptions?"True":"False")},o.default.createElement("div",{className:"flow-closePopup",onClick:()=>N()},o.default.createElement(s,null)),o.default.createElement("div",{className:"flow-pos"},o.default.createElement("div",{className:"flow-optionsTitle"},"Options"),T.next.map(((e,t)=>o.default.createElement("div",{onClick:()=>N({componentName:e}),className:"flow-option",key:t},n?n.title(e):e))))):"",T.next.length>0?o.default.createElement("div",{className:"flow-side"},o.default.createElement("div",{className:"flow-innerSide"},o.default.createElement("div",{className:"flow-round",onClick:()=>{1!=a.component.next.length?f((e=>({...e,showAddOptions:!0}))):N(a.component.next[0])}},o.default.createElement(s,null)))):"")}const x=function({connectTo:t,forceUpdateParent:n,itemWidth:a,width:l,Logic:i,Tree:r,data:s,reRenderFullTree:c}){const[p,d]=e.useState({parentLineHeight:0,parentLineToTop:0,type:""}),[u,f]=e.useState(!1),m=()=>f((e=>!e)),h=e.useRef(null);function w(){let e=0,n=0,o="";if(t&&h.current){let a=t.getBoundingClientRect(),l=h.current.getBoundingClientRect(),i=a.y+a.height/2-(l.y+l.height/2);0==i?(e=20,n=10,o="straight"):i<0?(e=20-i,n=e-10,o="bottomToTop"):(e=i+20,n=10,o="topToBottom")}return{parentLineHeight:e,parentLineToTop:n,type:o}}const{parentLineHeight:v,parentLineToTop:g,type:y}=w();return e.useEffect((()=>{const e=setInterval((()=>function(){if(!t||!h.current)return;const{parentLineHeight:e,parentLineToTop:n,type:o}=w();e==p.parentLineHeight&&n==p.parentLineToTop&&o==p.type||d({parentLineHeight:e,parentLineToTop:n,type:o})}()),700);return()=>clearInterval(e)}),[p,t,h]),e.useEffect((()=>{t&&m()}),[t]),o.default.createElement("div",{className:"flow-graphPart",style:{width:l}},v&&g&&y?o.default.createElement("div",{className:"flow-lineToParrent",style:{bottom:`${g}px`}},o.default.createElement("svg",{viewBox:`0 0 80 ${v}`,height:`${v}px`,style:{minHeight:`${v}px`},xmlns:"http://www.w3.org/2000/svg"},"bottomToTop"==y?o.default.createElement("path",{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:`M0,10 C70,10 30,${v-10} 80,${v-10}`}):"topToBottom"==y?o.default.createElement("path",{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:`M0,${v-10} C70,${v-10} 30,10 80,10`}):o.default.createElement("path",{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:"M0,10 C70,10 30,10 80,10"}))):"",o.default.createElement("div",{ref:h,className:"flow-graph",style:{minWidth:a}},o.default.createElement(E,{Tree:r,Logic:i,data:s,graphInstanceForceUpdate:m,graphParrentInstanceForceUpdate:n,reRenderFullTree:c})),o.default.createElement("div",{className:"flow-next"},s.next.map(((e,t)=>o.default.createElement(x,{Tree:r,Logic:i,connectTo:h.current,forceUpdateParent:m,width:l-a,itemWidth:a,key:t,data:e,reRenderFullTree:c})))))};class y{constructor(){this.val=""}}exports.default=function({flow:t,logic:n,onChange:i}){const[s,c]=e.useState(!1),p=()=>c((e=>!e)),[d]=e.useState(new l),[u]=e.useState(new r(d,p)),[f]=e.useState(new y),[m,w]=e.useState(d.get());function v(){"function"==typeof i&&u.setExportFunc(i),"object"==typeof t&&u.import(t)}function g(){setTimeout((()=>{window.requestAnimationFrame((()=>{p(),setTimeout((()=>{p()}),100)}))}),1)}return e.useEffect((()=>{const e=a.default(n);e!=f.val?(f.val=e,w(d.parseNewLogic(n))):v()}),[]),e.useEffect((()=>{v()}),[m]),o.default.createElement("div",{className:"flowMakerComp"},o.default.createElement("div",{className:"flowMakerContainer",style:{minWidth:250+380*u.maxDepth+"px"}},o.default.createElement("div",{className:"flow-row",style:{minWidth:"250px"}},m.introComponents.length>0?o.default.createElement("div",{className:"flow-startPoint"},o.default.createElement("h3",null,"Start here"),o.default.createElement(h,{Tree:u,Logic:d,options:m.introComponents,out:e=>u.startFlow(e)})):""),o.default.createElement("div",{className:"flow-actualGraph",style:{width:380*u.maxDepth+"px"}},u.flow.map(((e,t)=>o.default.createElement(x,{Tree:u,Logic:d,width:380*u.maxDepth,itemWidth:380,key:t,data:e,reRenderFullTree:g}))))))};
//# sourceMappingURL=flowmaker.cjs.js.map
