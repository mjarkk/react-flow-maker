import e,{useState as t,useEffect as n,useRef as o}from"react";import a from"js-sha1";class i{constructor(){this.conf={components:{},introComponents:[]},this.errors=[]}title(e){return this.conf.components[e].title}get(){return this.conf}parseInput(e,t=(e=>console.log("logic parse warning:",e))){let n={name:e.name,title:e.title,type:e.type,validation:e.validation,tooltip:e.tooltip,default:e.default};switch(e.type){case"text":"string"!=typeof e.default&&void 0!==e.default&&(t(`.inputs[${e.name}].default must be a string or undefined, using default empty string`),n.default=""),null==e.default&&(n.default="");break;case"number":"number"!=typeof e.default&&void 0!==e.default&&(t(`.inputs[${e.name}].default must be a number or undefined, using default 0`),n.default=0),null==e.default&&(n.default=0);break;case"switch":"boolean"!=typeof e.default&&void 0!==e.default&&(t(`.inputs[${e.name}].default must be a boolean or undefined, using default empty string`),n.default=!1),null==e.default&&(n.default=!1);break;case"dropdown":if(!Array.isArray(e.options))return void t(`.inputs[${e.name}].options is not defined or is not an array, skipping this item`);n.options=e.options.map(((n,o)=>{if("string"==typeof n.title&&"string"==typeof n.value&&("string"==typeof n.tooltip||null==n.tooltip))return{title:n.title,tooltip:n.tooltip,value:n.value};t(`.inputs[${e.name}].options[${o}] does not have the correct items (title string, value string, tooltip string), skipping this item`)})).filter((e=>e));break;default:return void t(`.inputs[${e.name}].type = '${e.type}' is not valid, this input will be ignored`)}return n}parseNewLogic(e){const t=[],n=(...e)=>{t.push(e.join(" ")),console.log("logic parse warning:",...e)};let o={components:{},introComponents:[]};return e.components&&(Array.isArray(e.components)?(e.components.map(((e,t)=>{if(!e.name||!e.title)return void n(`logic.components[${t}] does not have a name or title field, this component will be ignored`);const a=[];let i={name:e.name,title:e.title,next:e.next?Array.isArray(e.next)?e.next:[e.next]:[],tooltip:e.tooltip,inputs:[],getInputs:void 0,advancedInputs:[]};e.getInputs&&(i.getInputs=e.getInputs),Array.isArray(e.inputs)&&e.inputs.map(((e,o)=>{if(!e.title||!e.name||!e.type)return void n(`logic.components[${t}].inputs[${o}] does not have a name, type or title field, this input will be ignored`);if("function"!=typeof e.validation&&void 0!==e.validation)return void n(`logic.components[${t}].inputs[${o}].validation must be undefined or a function`);if("string"!=typeof e.tooltip&&void 0!==e.tooltip)return void n(`logic.components[${t}].inputs[${o}].tooltip must be a string or not undefined`);if(-1!=a.indexOf(e.name))return void n(`logic.components[${t}].inputs[${o}].name can't be equal to other names`);const l=this.parseInput(e,(e=>n(`logic.components[${t}]${e}`)));l&&(a.push(e.name),i[e.advanced?"advancedInputs":"inputs"].push(l))})),o.components[e.name]=i})),Object.keys(o.components).map((e=>{o.components[e].next=o.components[e].next.filter((e=>!!o.components[e]||(n(`logic.component[???].next contains '${e}' that does not exsist, this item will be ignored`),!1)))}))):n("logic.components is not an array")),e.introComponents&&(Array.isArray(e.introComponents)?e.introComponents.map((e=>{o.components[e]?o.introComponents.push(e):n(`logic.introComponents['${e}'] is not a known component`)})):"string"==typeof e.introComponents?o.components[e.introComponents]?o.introComponents.push(e.introComponents):n(`logic.introComponents = '${name}' is not a known component`):n("logic.introComponents is not an array or string")),this.errors=t,this.conf=o,o}}var l={RandomString(e){let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<e;o++)t+=n.charAt(Math.floor(Math.random()*n.length));return t}};class r{constructor(e,t){this.Logic=e,this.forceUpdate=t,this.maxDepth=0,this.flow=[],this.exportBuzzy=!1,this.reExport=!1,this.exportFunc=void 0}setExportFunc(e){this.exportFunc=e}caclMaxDepth(){const e=this;this.maxDepth=0;const t=n=>{n.map((n=>{n.depth>e.maxDepth&&(e.maxDepth=n.depth),t(n.next)}))};t(this.flow),this.forceUpdate()}flowItem(e,t,n){const o=l.RandomString(20);return{depth:n+1,next:[],id:o,path:[...t,o],inputData:{},inputValidation:{},component:e}}startFlow(e){let t=this.Logic.conf.components[e];t&&(this.flow.push(this.flowItem(t,[],0)),this.caclMaxDepth(),this.export())}addComponent(e,t){let n=this.Logic.conf.components[e];if(!n)return;let o=this.findPath(t);o.next.push(this.flowItem(n,o.path,o.depth)),this.caclMaxDepth(),this.export()}findPath(e){let t;const n=o=>{for(let a=0;a<o.length;a++){if(o[a].path===e){t=o[a];break}n(o[a].next)}};return n(this.flow),t}removeComponent(e){const t=n=>{n=Object.assign([],n);for(let o=0;o<n.length;o++){if(n[o].path===e){n.splice(o,1);break}n[o].next=t(n[o].next)}return n};this.flow=t(this.flow),this.caclMaxDepth(),this.export()}itemToExport(e){let t={},n={};return Object.keys(e.inputData).map((o=>{t[o]=e.inputData[o].value,e.inputData[o].error&&(n[o]=e.inputData[o].error)})),{component:{title:e.component.title,name:e.component.name},inputs:t,inputErrors:n,id:e.id,next:[]}}export(){this.exportBuzzy?this.reExport=!0:(this.exportBuzzy=!0,setTimeout((()=>{if(this.reExport)return this.exportBuzzy=!1,this.reExport=!1,void this.export();let e=[];const t=(e,n)=>{n.map((n=>{e.push(this.itemToExport(n)),t(e[e.length-1].next,n.next)}))};t(e,this.flow),"function"==typeof this.exportFunc&&this.exportFunc(e),setTimeout((()=>{this.exportBuzzy=!1,this.reExport&&(this.reExport=!1,this.export())}),30)}),50))}import(e){if(!Array.isArray(e))return;let t=[];const n=(e,t,o)=>{e.map((e=>{let a=this.flowItem(this.Logic.conf.components[e.component.name],o,o.length);a.id=e.id,a.inputData=Object.keys(e.inputs).reduce(((t,n)=>(t[n]={value:e.inputs[n],error:""},t)),{}),a.path.splice(-1,1),a.path.push(e.id),t.push(a),n(e.next,t[t.length-1].next,[...o,e.id])}))};n(e,t,[]),this.flow=t,this.caclMaxDepth()}updateInputValue(e,t,n){let o=this.findPath(e);o&&(o.inputData[n]=t),this.export()}}const s=()=>e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},e.createElement("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}),e.createElement("path",{d:"M0 0h24v24H0z",fill:"none"})),p=()=>e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},e.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),e.createElement("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v10zM18 4h-2.5l-.71-.71c-.18-.18-.44-.29-.7-.29H9.91c-.26 0-.52.11-.7.29L8.5 4H6c-.55 0-1 .45-1 1s.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1z"})),c=()=>e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},e.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),e.createElement("path",{d:"M8.71 11.71l2.59 2.59c.39.39 1.02.39 1.41 0l2.59-2.59c.63-.63.18-1.71-.71-1.71H9.41c-.89 0-1.33 1.08-.7 1.71z"})),m=()=>e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},e.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),e.createElement("path",{d:"M8.71 12.29L11.3 9.7c.39-.39 1.02-.39 1.41 0l2.59 2.59c.63.63.18 1.71-.71 1.71H9.41c-.89 0-1.33-1.08-.7-1.71z"})),d=()=>e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24"},e.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),e.createElement("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1zm1-8h-2V7h2v2z"})),u=()=>e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},e.createElement("path",{d:"M0 0h24v24H0z",fill:"none"}),e.createElement("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})),h=()=>e.createElement("svg",{className:"flow-alertIcon",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},e.createElement("path",{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}),e.createElement("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.createElement("line",{x1:"12",y1:"17",x2:"12",y2:"17"}));function f({options:n,Logic:o,out:a}){const[i,l]=t(!1);return e.createElement("div",{className:"flow-addIcon"},e.createElement("div",{className:"flow-round "+(i?"flow-open":"flow-closed"),onClick:()=>l((e=>!e))},e.createElement(s,null)),e.createElement("div",{className:"flow-options "+(i?"flow-open":"flow-closed")},n?n.map(((t,n)=>e.createElement("div",{onClick:()=>function(e){a(e),l(!1)}(t),key:n,className:"flow-option"},o?o.title(t):t))):""))}function w({tip:t,transparrent:n}){return t?e.createElement("div",{className:"flow-tooltip flow-transparrent"+(n?"True":"False")},e.createElement("div",{className:"flow-icon"},e.createElement(d,null)),e.createElement("div",{className:"flow-noWidth"},e.createElement("div",{className:"flow-fullwidth"},e.createElement("div",{className:"flow-popup"},t)))):""}class v{constructor(){this.val=""}}function g({onChange:o,hiddenDropdown:a,input:i,refID:l,initalVal:r}){const[s]=t(new v),[p,m]=t({dropDownopen:!1}),[d,h]=t(!1),[f,g]=t(void 0),[E,x]=t("");function y(){if(i&&!d||s.val!=l){s.val=l;let e=void 0!==r?r:i.default;void 0===e&&("text"==i.type||"number"==i.type?e="":"switch"==i.type&&(e=!1)),g(e),h(!0)}}let N;if(n((()=>{if("function"==typeof i.validation&&void 0!==f){let e=i.validation(void 0,f);"string"!=typeof e&&(e=""),x(e)}}),[f]),n((()=>{!o||void 0===f&&"dropdown"!=i.type||o({error:E,value:"number"==i.type?"number"==typeof f?f:Number(f):f})}),[f,E]),n((()=>y()),[]),n((()=>{if("dropdown"==i.type&&void 0!==f){const e=i?.options?.find((e=>e.value===f))?.value||(i?.options&&i?.options[0])?.value||void 0;e!==f&&g(e)}}),[i]),n((()=>{y(),a&&p.dropDownopen&&m((e=>({...e,dropDownopen:!1})))}),[a]),!i)return e.createElement("div",{className:"flow-input"});const T=()=>e.createElement("div",{className:"flow-label",onClick:()=>N?N.focus():"switch"==i.type?g(!f):""},e.createElement("span",null,i.title),e.createElement(w,{transparrent:!0,tip:i.tooltip}));return e.createElement("div",{className:`flow-input flow-input-type-${i.type} flow-hasErr${E?"True":"False"}`},"switch"!=i.type?e.createElement(T,null):"",e.createElement("div",{className:"flow-actualInput"},void 0===f||"text"!=i.type&&"number"!=i.type?void 0!==f&&"switch"==i.type?e.createElement("div",{className:"flow-switch"},e.createElement("div",{onClick:()=>g(!f),className:"flow-actualSwitch "+(f?"flow-true":"flow-false")},e.createElement("div",{className:"flow-inside"},e.createElement(u,null)))):"dropdown"==i.type?e.createElement("div",{className:"flow-dropdown"},e.createElement("div",{className:"flow-select",onClick:()=>m((e=>({...e,dropDownopen:!p.dropDownopen})))},e.createElement("div",{className:"flow-optTitle"},i.options?.length&&i.options.find((e=>e.value===f))?.title||"..."),e.createElement("div",{className:"flow-icon"},i.options&&0!=i.options.length?e.createElement(c,null):"")),e.createElement("div",{className:"flow-options flow-open"+(p.dropDownopen?"True":"False")},i.options.map(((t,n)=>e.createElement("div",{key:n,className:"flow-option",onClick:()=>{g(t.value),m((e=>({...e,dropDownopen:!1})))}},e.createElement("div",{className:"flow-optTitle"},t.title),e.createElement(w,{tip:t.tooltip})))))):"":e.createElement("div",{className:"flow-text"},e.createElement("input",{ref:e=>N=e,value:f,onChange:e=>{"number"==i.type?g([...e.target.value].filter(((e,t)=>/[0-9.]/.test(e)||0==t&&"-"==e)).join("")):g(e.target.value)}}))),"switch"==i.type?e.createElement(T,null):"",E?e.createElement("div",{className:"flow-error"},E):"")}function E({Tree:o,Logic:a,data:i,graphInstanceForceUpdate:l,graphParrentInstanceForceUpdate:r,reRenderFullTree:d}){let[u,f]=t({hover:!1,showAddOptions:!1});const[v,E]=t(!1),[x,y]=t(!1),N=()=>y((e=>!e));function T(e){f((e=>({...e,showAddOptions:!1}))),e&&(o.addComponent(e,i.path),d())}if(n((()=>{r?r():l&&l()}),[v]),!i)return"";const k=i.component;let{inputs:C,advancedInputs:b}=k;if(k.getInputs){const e=o.itemToExport(i);let t=k.getInputs(e);Array.isArray(t)&&(C=[],b=[],t.map((e=>{const t=a.parseInput(e);t&&(e.advanced?b.push(t):C.push(t))})))}return e.createElement("div",{className:"flow-fullBlock flow-hover"+(u.hover&&!u.showAddOptions?"True":"False"),onMouseEnter:()=>{u.hover||f((e=>({...e,hover:!0})))},onMouseLeave:()=>{u.hover&&f((e=>({...e,hover:!1})))}},e.createElement("div",{className:"flow-side"},e.createElement("div",{className:"flow-innerSide"},e.createElement("div",{className:"flow-round",onClick:function(){o.removeComponent(i.path),d()}},e.createElement(p,null)))),e.createElement("div",{className:"flow-middle"},e.createElement("div",{className:"flow-title"},k.title,e.createElement(w,{transparrent:!0,tip:k.tooltip})),e.createElement("div",{className:"flow-inputs"},C.map((t=>{const n=i.inputData[t.name];return e.createElement(g,{refID:i.id,key:t.name,input:t,initalVal:n?n.value:void 0,onChange:e=>{o.updateInputValue(i.path,e,t.name),N()}})})),b.length>0?(()=>{const t=b.filter((e=>!0!==(!i.inputData[e.name]||!e.validation||e.validation(void 0,i.inputData[e.name].value)))).length>0&&!v;return e.createElement("div",{className:"flow-showAdvanced"},e.createElement("div",{className:"flow-button error"+(t?"True":"False"),onClick:()=>E(!v)},t?e.createElement(h,null):"","Advanced ",v?e.createElement(m,null):e.createElement(c,null)))})():""),e.createElement("div",{className:"flow-inputs flow-advancedInputs flow-show"+(v?"True":"False")},b.map(((t,n)=>{const a=i.inputData[t.name];return e.createElement(g,{hiddenDropdown:!v,key:n,input:t,initalVal:a?a.value:void 0,onChange:e=>{o.updateInputValue(i.path,e,t.name),N()}})})))),k.next.length>0?e.createElement("div",{className:"flow-nextOptions flow-show"+(u.showAddOptions?"True":"False")},e.createElement("div",{className:"flow-closePopup",onClick:()=>T()},e.createElement(s,null)),e.createElement("div",{className:"flow-pos"},e.createElement("div",{className:"flow-optionsTitle"},"Options"),k.next.map(((t,n)=>e.createElement("div",{onClick:()=>T({componentName:t}),className:"flow-option",key:n},a?a.title(t):t))))):"",k.next.length>0?e.createElement("div",{className:"flow-side"},e.createElement("div",{className:"flow-innerSide"},e.createElement("div",{className:"flow-round",onClick:()=>{1!=i.component.next.length?f((e=>({...e,showAddOptions:!0}))):T(i.component.next[0])}},e.createElement(s,null)))):"")}const x=function({connectTo:a,forceUpdateParent:i,itemWidth:l,width:r,Logic:s,Tree:p,data:c,reRenderFullTree:m}){const[d,u]=t({parentLineHeight:0,parentLineToTop:0,type:""}),[h,f]=t(!1),w=()=>f((e=>!e)),v=o(null);function g(){let e=0,t=0,n="";if(a&&v.current){let o=a.getBoundingClientRect(),i=v.current.getBoundingClientRect(),l=o.y+o.height/2-(i.y+i.height/2);0==l?(e=20,t=10,n="straight"):l<0?(e=20-l,t=e-10,n="bottomToTop"):(e=l+20,t=10,n="topToBottom")}return{parentLineHeight:e,parentLineToTop:t,type:n}}const{parentLineHeight:y,parentLineToTop:N,type:T}=g();return n((()=>{const e=setInterval((()=>function(){if(!a||!v.current)return;const{parentLineHeight:e,parentLineToTop:t,type:n}=g();e==d.parentLineHeight&&t==d.parentLineToTop&&n==d.type||u({parentLineHeight:e,parentLineToTop:t,type:n})}()),700);return()=>clearInterval(e)}),[d,a,v]),n((()=>{a&&w()}),[a]),e.createElement("div",{className:"flow-graphPart",style:{width:r}},y&&N&&T?e.createElement("div",{className:"flow-lineToParrent",style:{bottom:`${N}px`}},e.createElement("svg",{viewBox:`0 0 80 ${y}`,height:`${y}px`,style:{minHeight:`${y}px`},xmlns:"http://www.w3.org/2000/svg"},"bottomToTop"==T?e.createElement("path",{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:`M0,10 C70,10 30,${y-10} 80,${y-10}`}):"topToBottom"==T?e.createElement("path",{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:`M0,${y-10} C70,${y-10} 30,10 80,10`}):e.createElement("path",{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:"M0,10 C70,10 30,10 80,10"}))):"",e.createElement("div",{ref:v,className:"flow-graph",style:{minWidth:l}},e.createElement(E,{Tree:p,Logic:s,data:c,graphInstanceForceUpdate:w,graphParrentInstanceForceUpdate:i,reRenderFullTree:m})),e.createElement("div",{className:"flow-next"},c.next.map(((t,n)=>e.createElement(x,{Tree:p,Logic:s,connectTo:v.current,forceUpdateParent:w,width:r-l,itemWidth:l,key:n,data:t,reRenderFullTree:m})))))};class y{constructor(){this.val=""}}function N({flow:o,logic:l,onChange:s}){const[p,c]=t(!1),m=()=>c((e=>!e)),[d]=t(new i),[u]=t(new r(d,m)),[h]=t(new y),[w,v]=t(d.get());function g(){"function"==typeof s&&u.setExportFunc(s),"object"==typeof o&&u.import(o)}function E(){setTimeout((()=>{window.requestAnimationFrame((()=>{m(),setTimeout((()=>{m()}),100)}))}),1)}return n((()=>{const e=a(l);e!=h.val?(h.val=e,v(d.parseNewLogic(l))):g()}),[]),n((()=>{g()}),[w]),e.createElement("div",{className:"flowMakerComp"},e.createElement("div",{className:"flowMakerContainer",style:{minWidth:250+380*u.maxDepth+"px"}},e.createElement("div",{className:"flow-row",style:{minWidth:"250px"}},w.introComponents.length>0?e.createElement("div",{className:"flow-startPoint"},e.createElement("h3",null,"Start here"),e.createElement(f,{Tree:u,Logic:d,options:w.introComponents,out:e=>u.startFlow(e)})):""),e.createElement("div",{className:"flow-actualGraph",style:{width:380*u.maxDepth+"px"}},u.flow.map(((t,n)=>e.createElement(x,{Tree:u,Logic:d,width:380*u.maxDepth,itemWidth:380,key:n,data:t,reRenderFullTree:E}))))))}export default N;
//# sourceMappingURL=flowmaker.es.js.map
