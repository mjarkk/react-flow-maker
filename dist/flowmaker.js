"use strict";var t=require("react"),e=require("js-sha1");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o=n(t),a=n(e);function i(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,r(t,e)}function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var l=function(){function t(){this.conf={components:{},introComponents:[]},this.errors=[]}var e=t.prototype;return e.title=function(t){return this.conf.components[t].title},e.get=function(){return this.conf},e.parseNewLogic=function(t){var e=[],n=function(){var t,n=[].slice.call(arguments);e.push(n.join(" ")),(t=console).log.apply(t,["logic parse warning:"].concat(n))},o={components:{},introComponents:[]};return t.components&&(Array.isArray(t.components)?(t.components.map(function(t,e){if(t.name&&t.title){var a=[],i={name:t.name,title:t.title,next:t.next?Array.isArray(t.next)?t.next:[t.next]:[],tooltip:t.tooltip,inputs:[],advancedInputs:[]};Array.isArray(t.inputs)&&t.inputs.map(function(t,o){if(t.title&&t.name&&t.type)if("function"==typeof t.validation||void 0===t.validation)if("string"==typeof t.tooltip||void 0===t.tooltip)if(-1==a.indexOf(t.name)){var r={name:t.name,title:t.title,type:t.type,validation:t.validation,tooltip:t.tooltip,default:t.default};switch(t.type){case"text":"string"!=typeof t.default&&void 0!==t.default&&(n("logic.components["+e+"].inputs["+o+"].default must be a string or undefined, using default empty string"),r.default=""),null==t.default&&(r.default="");break;case"number":"number"!=typeof t.default&&void 0!==t.default&&(n("logic.components["+e+"].inputs["+o+"].default must be a number or undefined, using default 0"),r.default=0),null==t.default&&(r.default=0);break;case"switch":"boolean"!=typeof t.default&&void 0!==t.default&&(n("logic.components["+e+"].inputs["+o+"].default must be a boolean or undefined, using default empty string"),r.default=!1),null==t.default&&(r.default=!1);break;case"dropdown":if(!Array.isArray(t.options))return void n("logic.components["+e+"].inputs["+o+"].options is not defined or is not an array, skipping this item");r.options=t.options.map(function(t,a){if("string"==typeof t.title&&"string"==typeof t.value&&("string"==typeof t.tooltip||null==t.tooltip))return{title:t.title,tooltip:t.tooltip,value:t.value};n("logic.components["+e+"].inputs["+o+"].options["+a+"] does not have the correct items (title string, value string, tooltip string), skipping this item")}).filter(function(t){return t});break;default:return void n("logic.components["+e+"].inputs["+o+"].type = '"+t.type+"' is not valid, this input will be ignored")}a.push(t.name),i[t.advanced?"advancedInputs":"inputs"].push(r)}else n("logic.components["+e+"].inputs["+o+"].name can't be equal to other names");else n("logic.components["+e+"].inputs["+o+"].tooltip must be a string or not undefined");else n("logic.components["+e+"].inputs["+o+"].validation must be undefined or a function");else n("logic.components["+e+"].inputs["+o+"] does not have a name, type or title field, this input will be ignored")}),o.components[t.name]=i}else n("logic.components["+e+"] does not have a name or title field, this component will be ignored")}),Object.keys(o.components).map(function(t){o.components[t].next=o.components[t].next.filter(function(t){return!!o.components[t]||(n("logic.component[???].next contains '"+t+"' that does not exsist, this item will be ignored"),!1)})})):n("logic.components is not an array")),t.introComponents&&(Array.isArray(t.introComponents)?t.introComponents.map(function(t){o.components[t]?o.introComponents.push(t):n("logic.introComponents['"+t+"'] is not a known component")}):"string"==typeof t.introComponents?o.components[t.introComponents]?o.introComponents.push(t.introComponents):n("logic.introComponents = '"+name+"' is not a known component"):n("logic.introComponents is not an array or string")),this.errors=e,this.conf=o,o},t}(),p=function(){function t(t,e){this.Logic=t,this.FlowMaker=e,this.maxDepth=0,this.flow=[],this.exportBuzzy=!1,this.reExport=!1,this.exportFunc=void 0}var e=t.prototype;return e.setExportFunc=function(t){this.exportFunc=t},e.caclMaxDepth=function(){var t=this;this.maxDepth=0,function e(n){n.map(function(n){n.depth>t.maxDepth&&(t.maxDepth=n.depth),e(n.next)})}(this.flow),this.FlowMaker.forceUpdate()},e.flowItem=function(t,e,n){var o=function(t){for(var e="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;o<20;o++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}();return{depth:n+1,next:[],id:o,path:[].concat(e,[o]),inputData:{},inputValidation:{},component:t}},e.startFlow=function(t){var e=this.Logic.conf.components[t];e&&(this.flow.push(this.flowItem(e,[],0)),this.caclMaxDepth(),this.export())},e.addComponent=function(t,e){var n=this.Logic.conf.components[t];if(n){var o=this.findPath(e);o.next.push(this.flowItem(n,o.path,o.depth)),this.caclMaxDepth(),this.export()}},e.findPath=function(t){var e=void 0;return function n(o){for(var a=0;a<o.length;a++){if(o[a].path===t){e=o[a];break}n(o[a].next)}}(this.flow),e},e.removeComponent=function(t){this.flow=function e(n){n=Object.assign([],n);for(var o=0;o<n.length;o++){if(n[o].path===t){n.splice(o,1);break}n[o].next=e(n[o].next)}return n}(this.flow),this.caclMaxDepth(),this.export()},e.export=function(){var t=this;this.exportBuzzy?this.reExport=!0:(this.exportBuzzy=!0,setTimeout(function(){if(t.reExport)return t.exportBuzzy=!1,t.reExport=!1,void t.export();var e=[];!function t(e,n){n.map(function(n){var o={},a={};Object.keys(n.inputData).map(function(t){o[t]=n.inputData[t].value,n.inputData[t].error&&(a[t]=n.inputData[t].error)}),e.push({component:{title:n.component.title,name:n.component.name},inputs:o,inputErrors:a,id:n.id,next:[]}),t(e[e.length-1].next,n.next)})}(e,t.flow),"function"==typeof t.exportFunc&&t.exportFunc(e),setTimeout(function(){t.exportBuzzy=!1,t.reExport&&(t.reExport=!1,t.export())},30)},50))},e.import=function(t){var e=this;if(Array.isArray(t)){var n=[];!function t(n,o,a){n.map(function(n){var i=e.flowItem(e.Logic.conf.components[n.component.name],a,a.length);i.id=n.id,i.inputData=Object.keys(n.inputs).reduce(function(t,e){return t[e]={value:n.inputs[e],error:""},t},{}),i.path.splice(-1,1),i.path.push(n.id),o.push(i),t(n.next,o[o.length-1].next,[].concat(a,[n.id]))})}(t,n,[]),this.flow=n,this.caclMaxDepth()}},e.updateInputValue=function(t,e,n,o){var a=this.findPath(t);a&&(o?a.component.advancedInputs&&a.component.advancedInputs[n]&&(a.inputData[a.component.advancedInputs[n].name]=e):a.component.inputs&&a.component.inputs[n]&&(a.inputData[a.component.inputs[n].name]=e)),this.export()},t}(),c=function(){return o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},o.default.createElement("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}),o.default.createElement("path",{d:"M0 0h24v24H0z",fill:"none"}))},u=function(){return o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},o.default.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),o.default.createElement("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v10zM18 4h-2.5l-.71-.71c-.18-.18-.44-.29-.7-.29H9.91c-.26 0-.52.11-.7.29L8.5 4H6c-.55 0-1 .45-1 1s.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1z"}))},d=function(){return o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},o.default.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),o.default.createElement("path",{d:"M8.71 11.71l2.59 2.59c.39.39 1.02.39 1.41 0l2.59-2.59c.63-.63.18-1.71-.71-1.71H9.41c-.89 0-1.33 1.08-.7 1.71z"}))},f=function(){return o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},o.default.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),o.default.createElement("path",{d:"M8.71 12.29L11.3 9.7c.39-.39 1.02-.39 1.41 0l2.59 2.59c.63.63.18 1.71-.71 1.71H9.41c-.89 0-1.33-1.08-.7-1.71z"}))},h=function(){return o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24"},o.default.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),o.default.createElement("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1zm1-8h-2V7h2v2z"}))},m=function(){return o.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},o.default.createElement("path",{d:"M0 0h24v24H0z",fill:"none"}),o.default.createElement("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"}))},v=function(){return o.default.createElement("svg",{className:"flow-alertIcon",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},o.default.createElement("path",{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}),o.default.createElement("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),o.default.createElement("line",{x1:"12",y1:"17",x2:"12",y2:"17"}))},w=function(t){function e(){var e;return(e=t.call(this)||this).state={open:!1},e}i(e,t);var n=e.prototype;return n.clickRoundButton=function(){this.setState({open:!this.state.open})},n.clickOption=function(t){this.props.out(t),this.setState({open:!1})},n.render=function(){var t=this,e=this.props,n=this.state;return o.default.createElement("div",{className:"flow-addIcon"},o.default.createElement("div",{className:"flow-round "+(n.open?"flow-open":"flow-closed"),onClick:function(){return t.clickRoundButton()}},o.default.createElement(c,null)),o.default.createElement("div",{className:"flow-options "+(n.open?"flow-open":"flow-closed")},e.options?e.options.map(function(e,n){return o.default.createElement("div",{onClick:function(){return t.clickOption(e)},key:n,className:"flow-option"},t.props?t.props.Logic.title(e):e)}):""))},e}(o.default.Component),g=function(t){function e(){return t.apply(this,arguments)||this}return i(e,t),e.prototype.render=function(){return this.props.tip?o.default.createElement("div",{className:"flow-tooltip flow-transparrent"+(this.props.transparrent?"True":"False")},o.default.createElement("div",{className:"flow-icon"},o.default.createElement(h,null)),o.default.createElement("div",{className:"flow-noWidth"},o.default.createElement("div",{className:"flow-fullwidth"},o.default.createElement("div",{className:"flow-popup"},this.props.tip)))):""},e}(o.default.Component),E=function(t){function e(){var e;return(e=t.call(this)||this).refID="",e.state={value:"",error:"",dropDownSelected:-1,isAfterInit:!1,dropDownopen:!1},e}i(e,t);var n=e.prototype;return n.tellParent=function(){this.props.onChange&&this.props.onChange({error:this.state.error,value:this.state.value})},n.updateDefaultVal=function(){var t=this;if(this.props.input&&!this.state.isAfterInit||this.refID!=this.props.refID){this.refID=this.props.refID;var e=void 0!==this.props.initalVal?this.props.initalVal:this.props.input.default;this.setState({value:e,isAfterInit:!0},function(){t.validate(e,function(){if("dropdown"==t.props.input.type&&-1==t.state.dropDownSelected){var n=0;t.props.input.options.map(function(t,o){t.value==e&&(n=o)}),t.setState({dropDownSelected:n})}t.tellParent()})})}},n.validate=function(t,e){if("function"==typeof this.props.input.validation){var n=this.props.input.validation(void 0,t);"string"!=typeof n&&(n=""),this.setState({error:n},e)}"function"==typeof e&&e()},n.updateValue=function(t){var e=this;this.setState({value:t},function(){e.validate(t,function(){e.tellParent()})})},n.componentDidMount=function(){this.updateDefaultVal()},n.componentDidUpdate=function(){this.updateDefaultVal(),this.props.hiddenDropdown&&this.state.dropDownopen&&this.setState({dropDownopen:!1})},n.render=function(){var t,e=this,n=this.state.error,a=this.props.input;if(!a)return o.default.createElement("div",{className:"flow-input"});var i=function(){return o.default.createElement("div",{className:"flow-label",onClick:function(){return t?t.focus():"switch"==a.type?e.updateValue(!e.state.value):""}},o.default.createElement("span",null,a.title),o.default.createElement(g,{transparrent:!0,tip:a.tooltip}))};return o.default.createElement("div",{className:"flow-input flow-input-type-"+a.type+" flow-hasErr"+(n?"True":"False")},"switch"!=a.type?o.default.createElement(i,null):"",o.default.createElement("div",{className:"flow-actualInput"},"text"==a.type||"number"==a.type?o.default.createElement("div",{className:"flow-text"},o.default.createElement("input",{ref:function(e){return t=e},type:a.type,value:this.state.value,onChange:function(t){return e.updateValue(t.target.value)}})):"switch"==a.type?o.default.createElement("div",{className:"flow-switch"},o.default.createElement("div",{onClick:function(){return e.updateValue(!e.state.value)},className:"flow-actualSwitch "+(this.state.value?"flow-true":"flow-false")},o.default.createElement("div",{className:"flow-inside"},o.default.createElement(m,null)))):"dropdown"==a.type?o.default.createElement("div",{className:"flow-dropdown"},o.default.createElement("div",{className:"flow-select",onClick:function(){return e.setState({dropDownopen:!e.state.dropDownopen})}},o.default.createElement("div",{className:"flow-optTitle"},-1!=this.state.dropDownSelected&&a.options&&0!=a.options.length?a.options[this.state.dropDownSelected].title:"..."),o.default.createElement("div",{className:"flow-icon"},a.options&&0!=a.options.length?o.default.createElement(d,null):"")),o.default.createElement("div",{className:"flow-options flow-open"+(this.state.dropDownopen?"True":"False")},a.options.map(function(t,n){return o.default.createElement("div",{key:n,className:"flow-option",onClick:function(){e.updateValue(t.value),e.setState({dropDownSelected:n,dropDownopen:!1})}},o.default.createElement("div",{className:"flow-optTitle"},t.title),o.default.createElement(g,{tip:t.tooltip}))}))):""),"switch"==a.type?o.default.createElement(i,null):"",n?o.default.createElement("div",{className:"flow-error"},n):"")},e}(o.default.Component),x=function(t){function e(){var e;return(e=t.call(this)||this).state={hover:!1,showAddOptions:!1,showAdvanced:!1},e.remove=e.remove.bind(s(e)),e}i(e,t);var n=e.prototype;return n.remove=function(){this.props.graphInstance.props.Tree.removeComponent(this.props.graphInstance.props.data.path)},n.add=function(){1!=this.props.graphInstance.props.data.component.next.length?this.setState({showAddOptions:!0}):this.realAdd(this.props.graphInstance.props.data.component.next[0])},n.realAdd=function(t){this.setState({showAddOptions:!1}),t&&this.props.graphInstance.props.Tree.addComponent(t,this.props.graphInstance.props.data.path)},n.render=function(){var t=this,e=this.props.graphInstance.props.data;if(!e)return"";var n,a=e.component,i=a.inputs,r=a.advancedInputs;return o.default.createElement("div",{className:"flow-fullBlock flow-hover"+(this.state.hover&&!this.state.showAddOptions?"True":"False"),onMouseOver:function(){t.state.hover||t.setState({hover:!0})},onMouseOut:function(){t.state.hover&&t.setState({hover:!1})}},o.default.createElement("div",{className:"flow-side"},o.default.createElement("div",{className:"flow-innerSide"},o.default.createElement("div",{className:"flow-round",onClick:this.remove},o.default.createElement(u,null)))),o.default.createElement("div",{className:"flow-middle"},o.default.createElement("div",{className:"flow-title"},a.title,o.default.createElement(g,{transparrent:!0,tip:a.tooltip})),o.default.createElement("div",{className:"flow-inputs"},i.map(function(n,a){var i=e.inputData[n.name];return o.default.createElement(E,{refID:e.id,key:a,input:n,initalVal:i?i.value:void 0,onChange:function(n){t.props.graphInstance.props.Tree.updateInputValue(e.path,n,a,!1)}})}),r.length>0?(n=r.filter(function(t){return!0!==(!e.inputData[t.name]||!t.validation||t.validation(void 0,e.inputData[t.name].value))}).length>0&&!t.state.showAdvanced,o.default.createElement("div",{className:"flow-showAdvanced"},o.default.createElement("div",{className:"flow-button error"+(n?"True":"False"),onClick:function(){t.setState({showAdvanced:!t.state.showAdvanced},function(){t.props.graphParrentInstance?t.props.graphParrentInstance.forceUpdate():t.props.graphInstance&&t.props.graphInstance.forceUpdate()})}},n?o.default.createElement(v,null):"","Advanced ",o.default.createElement(t.state.showAdvanced?f:d,null)))):""),o.default.createElement("div",{className:"flow-inputs flow-advancedInputs flow-show"+(this.state.showAdvanced?"True":"False")},r.map(function(n,a){var i=e.inputData[n.name];return o.default.createElement(E,{hiddenDropdown:!t.state.showAdvanced,key:a,input:n,initalVal:i?i.value:void 0,onChange:function(n){t.props.graphInstance.props.Tree.updateInputValue(e.path,n,a,!0)}})}))),a.next.length>0?o.default.createElement("div",{className:"flow-nextOptions flow-show"+(this.state.showAddOptions?"True":"False")},o.default.createElement("div",{className:"flow-closePopup",onClick:function(){return t.realAdd()}},o.default.createElement(c,null)),o.default.createElement("div",{className:"flow-pos"},o.default.createElement("div",{className:"flow-optionsTitle"},"Options"),a.next.map(function(e,n){return o.default.createElement("div",{onClick:function(){return t.realAdd({componentName:e})},className:"flow-option",key:n},t.props?t.props.graphInstance.props.Logic.title(e):e)}))):"",a.next.length>0?o.default.createElement("div",{className:"flow-side"},o.default.createElement("div",{className:"flow-innerSide"},o.default.createElement("div",{className:"flow-round",onClick:function(){return t.add()}},o.default.createElement(c,null)))):"")},e}(o.default.Component),y=function(t){function e(){var e;return(e=t.call(this)||this).state={element:void 0,lastParentPosition:0},e.mounted=!1,e}i(e,t);var n=e.prototype;return n.componentDidMount=function(){this.mounted=!0,this.watchParent()},n.componentWillUnmount=function(){this.mounted=!1},n.watchParent=function(){var t=this;if(this.mounted){var e=this.props.connectTo,n=void 0;e&&(n=e.getBoundingClientRect()).top!=this.state.lastParentPosition&&this.setState({lastParentPosition:n.top}),setTimeout(function(){t.watchParent()},800)}},n.render=function(){var t=this,e=0,n=0,a="";if(this.props.connectTo&&this.state.element){var i=this.props.connectTo.getBoundingClientRect(),r=this.state.element.getBoundingClientRect(),s=i.y+i.height/2-(r.y+r.height/2);0==s?(e=20,n=10,a="straight"):s<0?(n=(e=20-s)-10,a="bottomToTop"):(e=s+20,n=10,a="topToBottom")}return o.default.createElement("div",{className:"flow-graphPart",style:{width:this.props.width}},e&&n&&a?o.default.createElement("div",{className:"flow-lineToParrent",style:{bottom:n+"px"}},o.default.createElement("svg",{viewBox:"0 0 80 "+e,height:e+"px",style:{minHeight:e+"px"},xmlns:"http://www.w3.org/2000/svg"},o.default.createElement("path","bottomToTop"==a?{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:"M0,10 C70,10 30,"+(e-10)+" 80,"+(e-10)}:"topToBottom"==a?{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:"M0,"+(e-10)+" C70,"+(e-10)+" 30,10 80,10"}:{strokeWidth:"7",stroke:"#ccc",strokeLinecap:"round",fill:"none",d:"M0,10 C70,10 30,10 80,10"}))):"",o.default.createElement("div",{ref:function(e){var n=t.props.connectTo,o=void 0;if(n&&(o=n.getBoundingClientRect()),"object"!=typeof t.state.element||o&&o.top!=t.state.lastParentPosition){var a={element:e};o&&(a.lastParentPosition=o.top),t.setState(a)}},className:"flow-graph",style:{minWidth:this.props.itemWidth}},o.default.createElement(x,{graphInstance:this,graphParrentInstance:this.props.connectToInstance})),o.default.createElement("div",{className:"flow-next"},this.props.data.next.map(function(e,n){return o.default.createElement(y,{Tree:t.props.Tree,Logic:t.props.Logic,connectTo:t.state.element,connectToInstance:t,width:t.props.width-t.props.itemWidth,itemWidth:t.props.itemWidth,key:n,data:e})})))},e}(o.default.Component);module.exports=function(t){function e(){var e;return(e=t.call(this)||this).Logic=new l,e.Tree=new p(e.Logic,s(e)),e.lastlogicHash="",e.state={settings:e.Logic.get()},e}i(e,t);var n=e.prototype;return n.componentDidMount=function(){var t=this,e=a.default(this.props.logic);e!=this.lastlogicHash?(this.lastlogicHash=e,this.setState({settings:this.Logic.parseNewLogic(this.props.logic)},function(){return t.afterMount()})):this.afterMount()},n.afterMount=function(){"function"==typeof this.props.onChange&&this.Tree.setExportFunc(this.props.onChange),"object"==typeof this.props.flow&&this.Tree.import(this.props.flow)},n.render=function(){var t=this,e=this.state.settings;return o.default.createElement("div",{className:"flowMakerComp"},o.default.createElement("div",{className:"flowMakerContainer",style:{minWidth:250+380*this.Tree.maxDepth+"px"}},o.default.createElement("div",{className:"flow-row",style:{minWidth:"250px"}},e.introComponents.length>0?o.default.createElement("div",{className:"flow-startPoint"},o.default.createElement("h3",null,"Start here"),o.default.createElement(w,{Tree:this.Tree,Logic:this.Logic,options:e.introComponents,out:function(e){return t.Tree.startFlow(e)}})):""),o.default.createElement("div",{className:"flow-actualGraph",style:{width:380*this.Tree.maxDepth+"px"}},this.Tree.flow.map(function(e,n){return o.default.createElement(y,{Tree:t.Tree,Logic:t.Logic,width:380*t.Tree.maxDepth,itemWidth:380,key:n,data:e})}))))},e}(o.default.Component);
//# sourceMappingURL=flowmaker.js.map
